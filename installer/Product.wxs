<?xml version="1.0" encoding="UTF-8"?>
<Wix xmlns="http://wixtoolset.org/schemas/v4/wxs"
     xmlns:ui="http://wixtoolset.org/schemas/v4/wxs/ui">
  <Package Name="PeerTube Monitor"
           Manufacturer="DSU Teknik"
           Version="$(var.ProductVersion)"
           UpgradeCode="A8F3D2E1-4B5C-4D6E-8F7A-9B0C1D2E3F4A">

    <MajorUpgrade DowngradeErrorMessage="A newer version is already installed." />
    <Media Id="1" Cabinet="product.cab" EmbedCab="yes" />

    <StandardDirectory Id="ProgramFiles64Folder">
      <Directory Id="INSTALLFOLDER" Name="PeerTube Monitor">
        <Component Id="ExecutableComponent" Guid="F5E8D3C2-4B1A-4D6E-8F7A-9B0C1D2E3F4B">
          <File Source="..\peertube-monitor.exe" />
          <File Source="..\installer\README.txt" />

          <ServiceInstall
            Name="PeerTubeMonitor"
            DisplayName="PeerTube Monitor"
            Description="Automatically monitors folders and uploads videos to PeerTube"
            Type="ownProcess"
            Start="auto"
            Account="LocalSystem"
            ErrorControl="normal"
            Arguments='-config "[CommonAppDataFolder]PeerTube Monitor\config.json"' />

          <ServiceControl
            Id="StopService"
            Name="PeerTubeMonitor"
            Stop="both"
            Wait="yes"
            Remove="uninstall" />
        </Component>
      </Directory>
    </StandardDirectory>

    <SetProperty Id="WixQuietExec64CmdLine"
                 Value="&quot;[SystemFolder]sc.exe&quot; stop PeerTubeMonitor &amp; &quot;[SystemFolder]sc.exe&quot; delete PeerTubeMonitor"
                 Before="CleanupOrphanedService"
                 Sequence="execute"
                 Condition="NOT Installed" />

    <CustomAction Id="CleanupOrphanedService"
                  BinaryRef="Wix4UtilCA_X64"
                  DllEntry="WixQuietExec64"
                  Execute="deferred"
                  Impersonate="no"
                  Return="ignore" />

    <InstallExecuteSequence>
      <Custom Action="CleanupOrphanedService" After="InstallInitialize" Condition="NOT Installed" />
    </InstallExecuteSequence>

    <StandardDirectory Id="CommonAppDataFolder">
      <Directory Id="CONFIGFOLDER" Name="PeerTube Monitor">
        <Component Id="ConfigComponent" Guid="A1B2C3D4-5E6F-7A8B-9C0D-1E2F3A4B5C6D">
          <File Source="..\configs\config.example.json" Name="config.json" />
          <CreateFolder />
        </Component>
      </Directory>
    </StandardDirectory>

    <Feature Id="Complete">
      <ComponentRef Id="ExecutableComponent" />
      <ComponentRef Id="ConfigComponent" />
    </Feature>

    <ui:WixUI Id="WixUI_Minimal" />

    <WixVariable Id="WixUILicenseRtf" Value="License.rtf" />

    <Property Id="WIXUI_EXITDIALOGOPTIONALTEXT"
              Value="Installation complete! IMPORTANT: Before starting the service, edit config.json in C:\ProgramData\PeerTube Monitor\ to configure your PeerTube server and folder paths. See README.txt for detailed instructions." />

  </Package>
</Wix>
